<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Schedule - Water BU</title>
    <link rel="icon" type="image/x-icon" href="https://mgroupltd.com/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --accent-pink: #e91e8c;
            --accent-orange: #f7941d;
            --brand-gradient: linear-gradient(135deg, #e91e8c 0%, #f7941d 100%);
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8fafc;
            --bg-input: #f1f5f9;
            --text-primary: #1a2744;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --border-strong: #cbd5e1;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-glow: 0 4px 24px rgba(0, 0, 0, 0.08);

            /* Status colors - matching schedule-main */
            --status-leave: #10b981;
            --status-leave-bg: #d1fae5;
            --status-training: #8b5cf6;
            --status-training-bg: #ede9fe;
            --status-sickness: #f43f5e;
            --status-sickness-bg: #ffe4e6;
            --status-office: #0ea5e9;
            --status-office-bg: #e0f2fe;
            --status-night: #6366f1;
            --status-night-bg: #e0e7ff;
            --status-rest: #f59e0b;
            --status-rest-bg: #fef3c7;
            --status-wfh: #14b8a6;
            --status-wfh-bg: #ccfbf1;
            --status-travel: #ec4899;
            --status-travel-bg: #fce7f3;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            padding: 1rem 1rem 0.75rem;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .header h1 {
            font-family: 'Space Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            background: var(--brand-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-link {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.4rem 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 2rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .header-link:active {
            border-color: var(--accent-pink);
            color: var(--accent-pink);
        }

        /* Selector Row */
        .selector-row {
            display: flex;
            gap: 0.5rem;
        }

        .selector-wrap {
            flex: 1;
            position: relative;
        }

        .selector-wrap select {
            width: 100%;
            padding: 0.625rem 2rem 0.625rem 0.75rem;
            font-size: 0.875rem;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-input);
            color: var(--text-primary);
            appearance: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .selector-wrap select:focus {
            outline: none;
            border-color: var(--accent-pink);
            box-shadow: 0 0 0 3px rgba(233, 30, 140, 0.1);
        }

        .selector-wrap select:disabled {
            background: var(--bg-primary);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        .selector-wrap::after {
            content: '';
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1rem;
            height: 1rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            pointer-events: none;
        }

        /* Week Navigator */
        .week-nav {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 0.625rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 90;
        }

        .week-nav.visible {
            display: flex;
        }

        .week-nav-inner {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            padding: 4px;
            border-radius: 10px;
            flex: 1;
            justify-content: space-between;
        }

        .week-nav-inner button {
            width: 2.25rem;
            height: 2.25rem;
            border: none;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            flex-shrink: 0;
            transition: all 0.15s ease;
        }

        .week-nav-inner button:active {
            background: var(--bg-primary);
        }

        .week-info {
            text-align: center;
            flex: 1;
            padding: 0 0.5rem;
        }

        .week-label {
            font-size: 0.9375rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .week-dates {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-top: 1px;
        }

        .week-badge {
            display: inline-block;
            font-size: 0.5625rem;
            font-weight: 600;
            padding: 0.125rem 0.4rem;
            border-radius: 1rem;
            margin-left: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .week-badge.current {
            background: var(--status-leave-bg);
            color: var(--status-leave);
        }

        .week-badge.next {
            background: var(--status-office-bg);
            color: var(--status-office);
        }

        .week-badge.past {
            background: var(--bg-input);
            color: var(--text-muted);
        }

        /* Quick Week Buttons */
        .quick-weeks {
            display: none;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 88;
            justify-content: center;
        }

        .quick-weeks.visible {
            display: flex;
        }

        .quick-week-btn {
            padding: 0.4375rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 2rem;
            font-size: 0.8125rem;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.15s ease;
        }

        .quick-week-btn:active {
            border-color: var(--accent-pink);
        }

        .quick-week-btn.active {
            background: var(--brand-gradient);
            border-color: transparent;
            color: white;
        }

        /* Content */
        .content {
            padding: 1rem;
            padding-bottom: 2rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 1.5rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-state-text {
            font-size: 1.0625rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .empty-state-sub {
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Day Card */
        .day-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .day-card.past {
            opacity: 0.55;
        }

        .day-card.weekend-empty {
            display: none;
        }

        .day-header {
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-name {
            font-weight: 700;
            font-size: 0.9375rem;
            color: var(--text-primary);
        }

        .day-date {
            font-size: 0.8125rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .day-header.today {
            background: var(--brand-gradient);
        }

        .day-header.today .day-name,
        .day-header.today .day-date {
            color: white;
        }

        .day-content {
            padding: 0.5rem;
        }

        .day-empty {
            padding: 1.25rem 1rem;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8125rem;
        }

        /* Job Item */
        .job-item {
            padding: 0.75rem;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background 0.15s ease;
            border-left: 4px solid var(--accent-pink);
            background: var(--bg-tertiary);
        }

        .job-item:last-child {
            margin-bottom: 0;
        }

        .job-item:active {
            background: var(--border-color);
        }

        .job-item.night {
            border-left-color: var(--status-night);
            background: var(--status-night-bg);
        }

        .job-item.inactive {
            border-left-color: #ef4444;
            opacity: 0.75;
        }

        .job-item.pending {
            border-left-color: var(--status-rest);
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.25rem;
        }

        .job-q {
            font-weight: 700;
            font-size: 0.9375rem;
            color: var(--accent-pink);
        }

        .job-status {
            font-size: 0.625rem;
            font-weight: 600;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .job-status.live {
            background: var(--status-leave-bg);
            color: var(--status-leave);
        }

        .job-status.pending {
            background: var(--status-rest-bg);
            color: var(--status-rest);
        }

        .job-status.inactive {
            background: var(--status-sickness-bg);
            color: var(--status-sickness);
        }

        .job-client {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.125rem;
        }

        .job-location {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .job-location svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .job-meta {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.375rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .job-meta svg {
            width: 12px;
            height: 12px;
            vertical-align: -1px;
            margin-right: 2px;
        }

        /* Status Entry */
        .status-item {
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9375rem;
        }

        .status-item.leave { background: var(--status-leave-bg); color: var(--status-leave); }
        .status-item.training { background: var(--status-training-bg); color: var(--status-training); }
        .status-item.sickness { background: var(--status-sickness-bg); color: var(--status-sickness); }
        .status-item.office { background: var(--status-office-bg); color: var(--status-office); }
        .status-item.night { background: var(--status-night-bg); color: var(--status-night); }
        .status-item.rest { background: var(--status-rest-bg); color: var(--status-rest); }
        .status-item.wfh { background: var(--status-wfh-bg); color: var(--status-wfh); }
        .status-item.travel { background: var(--status-travel-bg); color: var(--status-travel); }

        /* Job Detail Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 200;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            width: 100%;
            max-height: 85vh;
            border-radius: 1.25rem 1.25rem 0 0;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.25s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-handle {
            width: 2rem;
            height: 0.25rem;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0.5rem auto 0;
        }

        .modal-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 1.0625rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            width: 2rem;
            height: 2rem;
            border: 1px solid var(--border-color);
            background: var(--bg-input);
            border-radius: 8px;
            font-size: 1.125rem;
            cursor: pointer;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .modal-close:active {
            border-color: var(--accent-pink);
            color: var(--accent-pink);
        }

        .modal-body {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }

        .detail-row {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-size: 0.9375rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .detail-value.highlight {
            color: var(--accent-pink);
            font-weight: 700;
        }

        .partners-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-top: 0.25rem;
        }

        .partner-tag {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            padding: 0.25rem 0.625rem;
            border-radius: 2rem;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 2rem;
            height: 2rem;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-pink);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Swipe hint */
        .swipe-hint {
            text-align: center;
            font-size: 0.6875rem;
            color: var(--text-muted);
            padding: 0.25rem 0 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .swipe-hint.visible {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header" id="stickyHeader">
        <div class="header-top">
            <h1>My Schedule</h1>
            <a href="https://skillsmatrix.github.io/schedule/" class="header-link">Full Schedule ‚Üí</a>
        </div>
        <div class="selector-row">
            <div class="selector-wrap">
                <select id="workstreamSelect" onchange="onWorkstreamChange()">
                    <option value="">Select workstream...</option>
                </select>
            </div>
            <div class="selector-wrap">
                <select id="techSelect" onchange="onTechChange()" disabled>
                    <option value="">Select your name...</option>
                </select>
            </div>
        </div>
    </header>

    <!-- Week Navigation -->
    <nav class="week-nav" id="weekNav">
        <div class="week-nav-inner">
            <button onclick="previousWeek()" aria-label="Previous week">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <div class="week-info">
                <div class="week-label" id="weekLabel">Week 5</div>
                <div class="week-dates" id="weekDates">27 Jan - 2 Feb</div>
            </div>
            <button onclick="nextWeek()" aria-label="Next week">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
            </button>
        </div>
    </nav>

    <!-- Quick Week Selection -->
    <div class="quick-weeks" id="quickWeeks">
        <button class="quick-week-btn" onclick="goToWeek(-1)" id="prevWeekBtn">Last Week</button>
        <button class="quick-week-btn active" onclick="goToWeek(0)" id="thisWeekBtn">This Week</button>
        <button class="quick-week-btn" onclick="goToWeek(1)" id="nextWeekBtn">Next Week</button>
    </div>

    <!-- Swipe hint -->
    <div class="swipe-hint" id="swipeHint">Swipe left or right to change week</div>

    <!-- Content -->
    <main class="content" id="content">
        <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <div class="empty-state-text">Select your name above</div>
            <div class="empty-state-sub">to view your schedule</div>
        </div>
    </main>

    <!-- Job Detail Modal -->
    <div class="modal-overlay" id="jobModal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Job Details</div>
                <button class="modal-close" onclick="closeModal()" aria-label="Close">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase config
        const SUPABASE_URL = 'https://tcjaegtublrlkyxveloh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjamFlZ3R1YmxybGt5eHZlbG9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNzc4MzMsImV4cCI6MjA4Mzk1MzgzM30.4aNJQZ2REe_njrdVyhefDomnrKQo2zMo-iDJnGhxRXI';

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let TECHNICIANS = [];
        let WORKSTREAMS = [];
        let selectedWorkstream = null;
        let selectedTechId = null;
        let currentWeekStart = getMonday(new Date());
        let thisWeekStart = getMonday(new Date());
        let currentEntries = []; // Store entries for job detail lookup

        // Sanitize text for safe HTML insertion
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Get Monday of a given week
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        // Format date as YYYY-MM-DD using local time (avoids UTC timezone shift)
        function toDateString(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // SVG icon helpers
        const icons = {
            pin: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>',
            users: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
            moon: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
            user: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
        };

        // Load technicians
        async function loadTechnicians() {
            try {
                const { data, error } = await supabaseClient
                    .from('technicians')
                    .select('*')
                    .order('name');

                if (error) {
                    console.error('Error loading technicians:', error);
                    document.getElementById('workstreamSelect').innerHTML = '<option value="">Error loading data</option>';
                    return;
                }

                if (!data || data.length === 0) {
                    document.getElementById('workstreamSelect').innerHTML = '<option value="">No technicians found</option>';
                    return;
                }

                TECHNICIANS = data;

                // Extract unique workstreams
                WORKSTREAMS = [...new Set(data.map(t => t.workstream).filter(Boolean))].sort();
                populateWorkstreamSelect();

                // Restore saved selections
                const savedWorkstream = localStorage.getItem('myScheduleWorkstream');
                const savedTechId = localStorage.getItem('myScheduleTechId');

                if (savedWorkstream && WORKSTREAMS.includes(savedWorkstream)) {
                    document.getElementById('workstreamSelect').value = savedWorkstream;
                    onWorkstreamChange();

                    if (savedTechId) {
                        const tech = TECHNICIANS.find(t => t.id === savedTechId && t.workstream === savedWorkstream);
                        if (tech) {
                            document.getElementById('techSelect').value = savedTechId;
                            onTechChange();
                        }
                    }
                }
            } catch (err) {
                console.error('Exception loading technicians:', err);
                document.getElementById('workstreamSelect').innerHTML = '<option value="">Error - check connection</option>';
            }
        }

        // Populate workstream dropdown
        function populateWorkstreamSelect() {
            const select = document.getElementById('workstreamSelect');
            select.innerHTML = '<option value="">Select workstream...</option>';

            WORKSTREAMS.forEach(ws => {
                const option = document.createElement('option');
                option.value = ws;
                option.textContent = ws;
                select.appendChild(option);
            });
        }

        // When workstream is selected
        function onWorkstreamChange() {
            const select = document.getElementById('workstreamSelect');
            selectedWorkstream = select.value;
            const techSelect = document.getElementById('techSelect');

            if (selectedWorkstream) {
                localStorage.setItem('myScheduleWorkstream', selectedWorkstream);
                techSelect.disabled = false;
                populateTechSelect();
            } else {
                localStorage.removeItem('myScheduleWorkstream');
                techSelect.disabled = true;
                techSelect.innerHTML = '<option value="">Select your name...</option>';
                hideSchedule();
            }

            // Reset tech selection
            selectedTechId = null;
            localStorage.removeItem('myScheduleTechId');
            hideSchedule();
        }

        // Populate tech dropdown (filtered by workstream)
        function populateTechSelect() {
            const select = document.getElementById('techSelect');
            select.innerHTML = '<option value="">Select your name...</option>';

            const filteredTechs = TECHNICIANS.filter(t => t.workstream === selectedWorkstream);

            filteredTechs.forEach(tech => {
                const option = document.createElement('option');
                option.value = tech.id;
                option.textContent = tech.name;
                select.appendChild(option);
            });
        }

        // Hide schedule UI
        function hideSchedule() {
            document.getElementById('weekNav').classList.remove('visible');
            document.getElementById('quickWeeks').classList.remove('visible');
            document.getElementById('swipeHint').classList.remove('visible');
            document.getElementById('content').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <div class="empty-state-text">Select your workstream and name</div>
                    <div class="empty-state-sub">to view your schedule</div>
                </div>
            `;
        }

        // Show schedule UI
        function showScheduleUI() {
            document.getElementById('weekNav').classList.add('visible');
            document.getElementById('quickWeeks').classList.add('visible');

            // Show swipe hint briefly on first use
            if (!localStorage.getItem('myScheduleSwipeHintSeen')) {
                const hint = document.getElementById('swipeHint');
                hint.classList.add('visible');
                setTimeout(() => {
                    hint.classList.remove('visible');
                    localStorage.setItem('myScheduleSwipeHintSeen', '1');
                }, 3000);
            }
        }

        // When tech is selected
        function onTechChange() {
            const select = document.getElementById('techSelect');
            selectedTechId = select.value;

            if (selectedTechId) {
                localStorage.setItem('myScheduleTechId', selectedTechId);
                showScheduleUI();
                loadSchedule();
            } else {
                localStorage.removeItem('myScheduleTechId');
                hideSchedule();
            }
        }

        // Navigate weeks
        function previousWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            loadSchedule();
        }

        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            loadSchedule();
        }

        function goToWeek(offset) {
            currentWeekStart = new Date(thisWeekStart);
            currentWeekStart.setDate(currentWeekStart.getDate() + (offset * 7));
            loadSchedule();
        }

        // Update week display
        function updateWeekDisplay() {
            const weekNum = getWeekNumber(currentWeekStart);
            const endDate = new Date(currentWeekStart);
            endDate.setDate(endDate.getDate() + 6);

            const startStr = currentWeekStart.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            const endStr = endDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });

            // Determine week badge
            const diffWeeks = Math.round((currentWeekStart - thisWeekStart) / (7 * 24 * 60 * 60 * 1000));
            let badge = '';
            if (diffWeeks === 0) {
                badge = '<span class="week-badge current">Current</span>';
            } else if (diffWeeks === 1) {
                badge = '<span class="week-badge next">Next</span>';
            } else if (diffWeeks === -1) {
                badge = '<span class="week-badge past">Last</span>';
            }

            document.getElementById('weekLabel').innerHTML = `Week ${weekNum}${badge}`;
            document.getElementById('weekDates').textContent = `${startStr} ‚Äì ${endStr}`;

            // Update quick week buttons
            document.querySelectorAll('.quick-week-btn').forEach(btn => btn.classList.remove('active'));
            if (diffWeeks === -1) document.getElementById('prevWeekBtn').classList.add('active');
            else if (diffWeeks === 0) document.getElementById('thisWeekBtn').classList.add('active');
            else if (diffWeeks === 1) document.getElementById('nextWeekBtn').classList.add('active');
        }

        // Get ISO week number
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // Load schedule for selected tech
        async function loadSchedule() {
            if (!selectedTechId) return;

            updateWeekDisplay();

            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Loading schedule...</div>
                </div>
            `;

            const endDate = new Date(currentWeekStart);
            endDate.setDate(endDate.getDate() + 6);

            try {
                const { data: entries, error } = await supabaseClient
                    .from('schedule_entries')
                    .select('*')
                    .eq('technician_id', selectedTechId)
                    .gte('date', toDateString(currentWeekStart))
                    .lte('date', toDateString(endDate))
                    .order('date');

                if (error) {
                    console.error('Error loading schedule:', error);
                    content.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ö†Ô∏è</div>
                            <div class="empty-state-text">Error loading schedule</div>
                            <div class="empty-state-sub">${escapeHtml(error.message)}</div>
                        </div>
                    `;
                    return;
                }

                currentEntries = entries || [];
                renderSchedule(currentEntries);
            } catch (err) {
                console.error('Network error loading schedule:', err);
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì°</div>
                        <div class="empty-state-text">Connection error</div>
                        <div class="empty-state-sub">Check your internet and try again</div>
                    </div>
                `;
            }
        }

        // Render schedule
        function renderSchedule(entries) {
            const content = document.getElementById('content');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            let html = '';

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(currentWeekStart);
                dayDate.setDate(dayDate.getDate() + i);
                const dateStr = toDateString(dayDate);
                const isToday = dayDate.getTime() === today.getTime();
                const isPast = dayDate < today;
                const isWeekend = i >= 5; // Saturday = 5, Sunday = 6

                const dayEntries = entries.filter(e => e.date === dateStr);
                const jobs = dayEntries.filter(e => e.entry_type === 'job');
                const statuses = dayEntries.filter(e => e.entry_type === 'status');
                const hasEntries = jobs.length > 0 || statuses.length > 0;

                // Collapse empty weekends
                const weekendEmptyClass = (isWeekend && !hasEntries) ? 'weekend-empty' : '';
                const pastClass = isPast ? 'past' : '';

                const dateDisplay = dayDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });

                html += `
                    <div class="day-card ${pastClass} ${weekendEmptyClass}">
                        <div class="day-header ${isToday ? 'today' : ''}">
                            <span class="day-name">${days[i]}</span>
                            <span class="day-date">${dateDisplay}</span>
                        </div>
                        <div class="day-content">
                `;

                if (statuses.length > 0) {
                    const status = statuses[0];
                    const statusLabels = {
                        leave: 'Annual Leave',
                        training: 'Training',
                        sickness: 'Sickness',
                        office: 'Office',
                        night: 'Night Shift',
                        rest: 'Rest Day',
                        wfh: 'Working from Home',
                        travel: 'Travel'
                    };
                    const statusType = escapeHtml(status.status_type);
                    html += `
                        <div class="status-item ${statusType}">
                            ${statusLabels[status.status_type] || escapeHtml(status.status_type)}
                            ${status.status_text ? `<br><span style="font-weight: 400; font-size: 0.8125rem;">${escapeHtml(status.status_text)}</span>` : ''}
                        </div>
                    `;
                } else if (jobs.length > 0) {
                    jobs.forEach(job => {
                        const statusClass = job.job_status === 'inactive' ? 'inactive' : job.job_status === 'pending' ? 'pending' : '';
                        const nightClass = job.is_night ? 'night' : '';

                        html += `
                            <div class="job-item ${statusClass} ${nightClass}" data-job-id="${escapeHtml(job.id)}" onclick="showJobDetail('${escapeHtml(job.id)}')">
                                <div class="job-header">
                                    <span class="job-q">${escapeHtml(job.q_number) || 'No Q#'}</span>
                                    <span class="job-status ${escapeHtml(job.job_status) || 'live'}">${escapeHtml(job.job_status) || 'Live'}</span>
                                </div>
                                <div class="job-client">${escapeHtml(job.client) || 'No client'}</div>
                                <div class="job-location">${icons.pin} ${escapeHtml(job.location) || 'No location'}</div>
                                ${job.partner || job.is_night ? `
                                    <div class="job-meta">
                                        ${job.partner ? `<span>${icons.users} ${escapeHtml(job.partner)}</span>` : ''}
                                        ${job.is_night ? `<span>${icons.moon} Night</span>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                } else {
                    html += `<div class="day-empty">No jobs scheduled</div>`;
                }

                html += `
                        </div>
                    </div>
                `;
            }

            content.innerHTML = html;
        }

        // Show job detail modal - looks up job by ID from stored entries
        function showJobDetail(jobId) {
            const job = currentEntries.find(e => e.id === jobId);
            if (!job) return;

            const modal = document.getElementById('jobModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            // Prevent background scrolling
            document.body.style.overflow = 'hidden';

            modalTitle.textContent = job.q_number || 'Job Details';

            const jobDate = new Date(job.date + 'T00:00:00');
            const dateStr = jobDate.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

            let partnersHtml = '';
            if (job.partner) {
                const partners = job.partner.split(',').map(p => p.trim());
                partnersHtml = `
                    <div class="detail-row">
                        <div class="detail-label">Working With</div>
                        <div class="partners-list">
                            ${partners.map(p => `<span class="partner-tag">${icons.user} ${escapeHtml(p)}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            modalBody.innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">Q Number</div>
                    <div class="detail-value highlight">${escapeHtml(job.q_number) || 'Not specified'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Status</div>
                    <div class="detail-value">
                        <span class="job-status ${escapeHtml(job.job_status) || 'live'}" style="font-size: 0.875rem;">${escapeHtml(job.job_status) || 'Live'}</span>
                        ${job.is_night ? '<span class="job-status" style="background: var(--status-night-bg); color: var(--status-night); font-size: 0.875rem; margin-left: 0.5rem;">Night Shift</span>' : ''}
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Date</div>
                    <div class="detail-value">${escapeHtml(dateStr)}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Client</div>
                    <div class="detail-value">${escapeHtml(job.client) || 'Not specified'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Location</div>
                    <div class="detail-value">${escapeHtml(job.location) || 'Not specified'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Task</div>
                    <div class="detail-value">${escapeHtml(job.task) || 'Not specified'}</div>
                </div>
                ${partnersHtml}
                ${job.project_manager ? `
                    <div class="detail-row">
                        <div class="detail-label">Project Manager</div>
                        <div class="detail-value">${escapeHtml(job.project_manager)}</div>
                    </div>
                ` : ''}
                ${job.notes ? `
                    <div class="detail-row">
                        <div class="detail-label">Notes</div>
                        <div class="detail-value" style="white-space: pre-wrap;">${escapeHtml(job.notes)}</div>
                    </div>
                ` : ''}
            `;

            modal.classList.add('open');
        }

        // Close modal
        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('jobModal').classList.remove('open');
            document.body.style.overflow = '';
        }

        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // ‚îÄ‚îÄ Swipe gesture support ‚îÄ‚îÄ
        (function() {
            let touchStartX = 0;
            let touchStartY = 0;
            let swiping = false;

            const content = document.getElementById('content');

            content.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
                swiping = true;
            }, { passive: true });

            content.addEventListener('touchend', (e) => {
                if (!swiping || !selectedTechId) return;
                swiping = false;

                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                const diffX = touchEndX - touchStartX;
                const diffY = touchEndY - touchStartY;

                // Only trigger if horizontal swipe is dominant and long enough
                if (Math.abs(diffX) > 80 && Math.abs(diffX) > Math.abs(diffY) * 1.5) {
                    if (diffX < 0) {
                        nextWeek();
                    } else {
                        previousWeek();
                    }
                }
            }, { passive: true });
        })();

        // Initialize
        loadTechnicians();
    </script>
</body>
</html>
